<nav class="navbar navbar-expand-lg">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('index') }}">
            <img src="{{ url_for('static', filename='img/logo.svg') }}" alt="Gearloom logo">
            <span>Gearloom</span>
        </a>
        <button class="navbar-toggle" type="button" aria-controls="navbar-mobile-panel" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggle-bar"></span>
            <span class="navbar-toggle-bar"></span>
            <span class="navbar-toggle-bar"></span>
        </button>
        <div id="navbar-mobile-panel" class="navbar-mobile-panel">
            <div class="navbar-nav align-items-center gap-3 flex-grow-1 w-100 flex-nowrap">
                <a class="nav-link {% if request.endpoint == 'about' %}active{% endif %}" href="{{ url_for('about') }}">
                    About
                </a>
                <form class="navbar-search" role="search" method="get" action="{{ url_for('products') }}">
                    <label class="visually-hidden" for="navbar-search-input">Search products</label>
                    <input
                        type="search"
                        id="navbar-search-input"
                        name="search"
                        class="navbar-search-input"
                        placeholder="Search products"
                        value="{{ request.args.get('search', '') if request.endpoint == 'products' else '' }}"
                    >
                    <button type="submit" class="navbar-search-btn">Search</button>
                </form>
                <a class="nav-link {% if request.endpoint == 'products' %}active{% endif %}" href="{{ url_for('products') }}">
                    Products
                </a>
                <a class="nav-link cart-link {% if request.endpoint == 'cart' %}active{% endif %}" href="{{ url_for('cart') }}">
                    Cart
                    {% if cart_item_count %}
                        <span class="cart-count">{{ cart_item_count }}</span>
                    {% endif %}
                </a>
                {% if current_user %}
                    <a class="nav-link {% if request.endpoint == 'seller_dashboard' %}active{% endif %}" href="{{ url_for('seller_dashboard') }}">
                        {% if current_seller %}
                            Seller Dashboard
                        {% else %}
                            Become a Seller
                        {% endif %}
                    </a>
                    <a class="user-pill{% if request.endpoint == 'orders_history' %} active{% endif %}" href="{{ url_for('orders_history') }}" title="View your orders">
                        {{ current_user['username']|replace(' ', '&nbsp;')|safe }}
                    </a>
                    <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
                {% else %}
                    <a class="nav-link {% if request.endpoint == 'seller_dashboard' %}active{% endif %}" href="{{ url_for('seller_dashboard') }}">
                        Become a Seller
                    </a>
                    <a class="nav-link" href="{{ url_for('login') }}">Login</a>
                    <a class="nav-link" href="{{ url_for('signup') }}">Sign up</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<script>
    (function () {
        if (window.__gearloomPwaInitialized) {
            return;
        }
        window.__gearloomPwaInitialized = true;

        const ensureManifest = () => {
            if (!document.querySelector('link[rel="manifest"]')) {
                const link = document.createElement("link");
                link.rel = "manifest";
                link.href = "{{ url_for('static', filename='manifest.json') }}";
                document.head.appendChild(link);
            }
        };

        const ensureThemeColor = () => {
            if (!document.querySelector('meta[name="theme-color"]')) {
                const meta = document.createElement("meta");
                meta.setAttribute("name", "theme-color");
                meta.setAttribute("content", "#0f62fe");
                document.head.appendChild(meta);
            }
        };

        ensureManifest();
        ensureThemeColor();

        const toggle = document.querySelector(".navbar-toggle");
        const panel = document.getElementById("navbar-mobile-panel");
        const closePanel = () => {
            if (!panel || !toggle) return;
            panel.classList.remove("is-open");
            toggle.setAttribute("aria-expanded", "false");
        };
        if (toggle && panel) {
            toggle.addEventListener("click", () => {
                const open = panel.classList.toggle("is-open");
                toggle.setAttribute("aria-expanded", open ? "true" : "false");
            });
            window.addEventListener("resize", () => {
                if (window.innerWidth >= 768) {
                    closePanel();
                }
            });
        }

        if ("serviceWorker" in navigator) {
            window.addEventListener("load", () => {
                navigator.serviceWorker
                    .register("/service-worker.js")
                    .catch((error) => console.warn("Service worker registration failed:", error));
            });
        }
    })();
</script>
